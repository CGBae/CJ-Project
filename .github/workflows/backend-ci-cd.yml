# .github/workflows/backend-ci-cd.yml

# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Backend CI/CD

# 1. ì‹¤í–‰ ì¡°ê±´: main ë¸Œëœì¹˜ì— pushë  ë•Œ
on:
  push:
    branches:
      - Git_CICD
    # ğŸ’¡ backend/ í´ë” ë˜ëŠ” requirements.txtê°€ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci-cd.yml'

jobs:
  build-and-deploy:
    # 2. ì‹¤í–‰ í™˜ê²½: ìµœì‹  ìš°ë¶„íˆ¬
    runs-on: ubuntu-latest

    steps:
      # 3. ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì˜´
      - name: Checkout code
        uses: actions/checkout@v4

      # 4. íŒŒì´ì¬ í™˜ê²½ ì„¤ì • (ì˜ˆ: 3.11 ë²„ì „)
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 5. ë°±ì—”ë“œ í´ë”ë¡œ ì´ë™í•˜ì—¬ íŒŒì´ì¬ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          # ğŸ’¡ requirements.txt íŒŒì¼ì´ ë°±ì—”ë“œ í´ë” ì•ˆì— ìˆì–´ì•¼ í•¨
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      # 6. (ì„ íƒì ) í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
      # - name: Run Tests
      #   working-directory: ./backend
      #   run: |
      #     pytest

      # 7. ë°°í¬ (SSH/SCP ì‚¬ìš©)
      # - name: Deploy to Server
      #   uses: appleboy/ssh-action@master
      #   with:
      #     # GitHub Secretsì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      #     host: ${{ secrets.SERVER_HOST }}
      #     username: ${{ secrets.SERVER_USER }}
      #     key: ${{ secrets.SERVER_SSH_KEY }}
      #     port: 22 # (ê¸°ë³¸ê°’, í•„ìš”ì‹œ ìˆ˜ì •)
          
      #     # ğŸ’¡ [ì¤‘ìš”] ì„œë²„ì— ì ‘ì†í•´ì„œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
      #     #    (ì„œë²„ ë‚´ í”„ë¡œì íŠ¸ ê²½ë¡œ, venv ê²½ë¡œ, systemd ì„œë¹„ìŠ¤ ì´ë¦„ì€ ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •!)
      #     script: |
      #       # 1. ì„œë²„ì˜ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
      #       cd /home/ubuntu/cjproject 
            
      #       # 2. GitHubì—ì„œ ìµœì‹  ì½”ë“œ ë°›ê¸°
      #       git pull origin main
            
      #       # 3. ë°±ì—”ë“œ í´ë”ë¡œ ì´ë™
      #       cd backend
            
      #       # 4. (í•„ìˆ˜) ê°€ìƒí™˜ê²½(venv) í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
      #       source venv/bin/activate
      #       pip install -r requirements.txt
            
      #       # 5. (í•„ìˆ˜) ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
      #       alembic upgrade head
            
      #       # 6. (í•„ìˆ˜) FastAPI ì„œë²„ ì¬ì‹œì‘ (Gunicorn + systemd ì‚¬ìš© ì˜ˆì‹œ)
      #       #    (ì„œë²„ ì„¤ì •ì— ë”°ë¼ 'sudo systemctl restart thera_music_backend' ë“±ìœ¼ë¡œ ë³€ê²½)
      #       sudo systemctl restart my-fastapi-app