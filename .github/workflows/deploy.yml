# .github/workflows/deploy.yml
# ì  í‚¨ìŠ¤(Jenkinsfile)ë¥¼ ëŒ€ì²´í•˜ëŠ” ê¹ƒí—ˆë¸Œ ì•¡ì…˜ íŒŒì¼

name: CI/CD (Frontend + Backend)

on:
  push:
    branches:
      - Git_CICD # ğŸ‘ˆ ì´ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
    paths:
      # ğŸ’¡ í”„ë¡ íŠ¸, ë°±ì—”ë“œ, ì•¤ì„œë¸” ì½”ë“œê°€ ë³€ê²½ë˜ë©´ ì‹¤í–‰
      - 'frontend/**'
      - 'backend/**'
      - 'ansible/deploy.yml'
      - 'docker-compose.yml'
      - '**/Dockerfile'
      - '.github/workflows/deploy.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # ğŸ’¡ ê¹ƒí—ˆë¸Œê°€ ì œê³µí•˜ëŠ” VM (ì  í‚¨ìŠ¤ ì—­í• )

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. (CI) í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ í…ŒìŠ¤íŠ¸ (Node.js ì„¤ì¹˜)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build Frontend (Test)
        working-directory: ./frontend
        run: |
          npm install
          # ğŸ’¡ ê¹ƒí—ˆë¸Œ ì‹œí¬ë¦¿ì„ ì‚¬ìš©í•´ .env íŒŒì¼ ìƒì„±
          echo "NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}" >> .env.local
          echo "NEXT_PUBLIC_KAKAO_REST_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_REST_KEY }}" >> .env.local
          echo "NEXT_PUBLIC_KAKAO_REDIRECT_URI=${{ secrets.NEXT_PUBLIC_KAKAO_REDIRECT_URI }}" >> .env.local
          npm run build

      # # 3. (CD) Ansible ì‹¤í–‰ (ì  í‚¨ìŠ¤ë¥¼ ëŒ€ì²´)
      # - name: Run Ansible Playbook
      #   uses: dawidd6/action-ansible-playbook@v2
      #   with:
      #     # 3-1. ì‹¤í–‰í•  ì‘ì—… ëª©ë¡ íŒŒì¼
      #     playbook: ansible/deploy.yml
          
      #     # 3-2. ì ‘ì†í•  í˜¸ìŠ¤íŠ¸ ì£¼ì†Œë¡ (hosts.ini ëŒ€ì‹  ì¸ë¼ì¸ìœ¼ë¡œ ì§€ì •)
      #     inventory: |
      #       [vms]
      #       cjproject-vm ansible_host=${{ secrets.SERVER_HOST }} ansible_user=${{ secrets.SERVER_USER }}

      #     # 3-3. SSH ë¹„ê³µê°œ í‚¤ (ê¹ƒí—ˆë¸Œ ì‹œí¬ë¦¿)
      #     key: ${{ secrets.SERVER_SSH_KEY }}
          
      #     # 3-4. ì•¤ì„œë¸”ì— ì¶”ê°€ ë³€ìˆ˜ ì „ë‹¬ (VM ë¹„ë°€ë²ˆí˜¸, DB URL ë“±)
      #     # ğŸ’¡ [ì¤‘ìš”] ì  í‚¨ìŠ¤ Credentials ID ëŒ€ì‹  {{ secrets.ë³€ìˆ˜ëª… }} ì‚¬ìš©
      #     options: |
      #       --extra-vars "ansible_password=${{ secrets.SERVER_PASSWORD }} DATABASE_URL=${{ secrets.DATABASE_URL }} SECRET_KEY=${{ secrets.SECRET_KEY }} KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }} NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }} NEXT_PUBLIC_KAKAO_REST_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_REST_KEY }} NEXT_PUBLIC_KAKAO_REDIRECT_URI=${{ secrets.NEXT_PUBLIC_KAKAO_REDIRECT_URI }}"