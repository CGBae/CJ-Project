# ansible/docker-compose.yml
version: '3.8'
services:
  frontend:
    # ì´ë¯¸ì§€ëŠ” Jenkins/Ansibleì´ ì™¸ë¶€ì—ì„œ ì£¼ì… (ì˜ˆ: ghcr.io/cgbae/cj-project/frontend:latest)
    image: ${FRONTEND_IMAGE_TAG}
    ports:
      - "80:3000" # â—€ Host 80í¬íŠ¸ë¥¼ ì»¨í…Œì´ë„ˆ 3000í¬íŠ¸ë¡œ ì—°ê²°
    restart: always
    env_file: # â¬‡ï¸ (ì¶”ê°€) ì´ íŒŒì¼ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì‚¬ìš©
      - ./frontend.env

  backend:
    # ì´ë¯¸ì§€ëŠ” Jenkins/Ansibleì´ ì™¸ë¶€ì—ì„œ ì£¼ì… (ì˜ˆ: ghcr.io/cgbae/cj-project/backend:latest)
    image: ${BACKEND_IMAGE_TAG}
    ports:
      - "8000:8000" # â—€ Host 8000í¬íŠ¸ë¥¼ ì»¨í…Œì´ë„ˆ 8000í¬íŠ¸ë¡œ ì—°ê²°
    restart: always
    env_file: # â¬‡ï¸ (ì¶”ê°€) ì´ íŒŒì¼ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì‚¬ìš©
      - ./backend.env
      - ./kafka.env
    depends_on:
      - db
      - redpanda
    volumes:
      # ğŸ”¥ backendì™€ music-workerê°€ ê°™ì´ ì“°ëŠ” static ë””ë ‰í† ë¦¬
      # ì»¨í…Œì´ë„ˆ ì•ˆ ê²½ë¡œëŠ” /app/static ìœ¼ë¡œ í†µì¼
      - static-data:/app/static

  db:
    image: postgres:15-alpine # (ë˜ëŠ” mysql:8)
    restart: always
    volumes:
      - db-data:/var/lib/postgresql/data # â—€ ë°ì´í„° ì˜êµ¬ ì €ì¥ì„ ìœ„í•¨
    env_file:
      - ./db.env
    ports:
    - "55432:5432"

  redpanda:
    image: redpandadata/redpanda:v23.3.10
    command:
      - redpanda start
      - --kafka-addr=0.0.0.0:9092
      - --advertise-kafka-addr=redpanda:9092
      - --overprovisioned
      - --smp=1
      - --memory=1024M
      - --reserve-memory=0M
      - --node-id=0
    ports:
      - "9092:9092"
      - "9644:9644" # admin
    restart: always

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: redpanda:9092
    ports:
      - "8081:8080"
    depends_on:
      - redpanda
    restart: always

  music-worker:
    image: ${BACKEND_IMAGE_TAG}
    depends_on:
      - backend
      - redpanda
    restart: always
    env_file:
      - ./backend.env   # ì•„ë˜ì—ì„œ ì„¤ëª…í•  .env(or backend.env)
      - ./kafka.env
    command: ["python", "-m", "app.workers.music_worker"]
    volumes:
      # ğŸ”¥ ì›Œì»¤ë„ ê°™ì€ static-data ë³¼ë¥¨ì„ /app/staticìœ¼ë¡œ ë§ˆìš´íŠ¸
      - static-data:/app/static

volumes:
  db-data:
  static-data: