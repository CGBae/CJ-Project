# ansible/playbook.yml
- hosts: localhost
  connection: local
  become: yes
  gather_facts: false

  vars:
    deploy_dir: /home/ubuntu/cj-project

  tasks:
    - name: 1. GHCR 로그인
      community.docker.docker_login:
        registry: ghcr.io
        username: "{{ ghcr_username }}"
        password: "{{ ghcr_password }}"
        reauthorize: true

    - name: 2. 배포 폴더 생성
      file:
        path: "{{ deploy_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    # === env 파일 생성 (CRLF 제거 + 마지막 개행 + 0600 + no_log) ===
    - name: 3. db.env 생성
      copy:
        content: "{{ db_env_b64 | b64decode | regex_replace(' +', '\n') | trim }}\n"
        dest: "{{ deploy_dir }}/db.env"
        owner: ubuntu
        group: ubuntu
        mode: "0600"
      no_log: true

    - name: 4. backend.env 생성
      copy:
        content: "{{ be_env_b64 | b64decode | regex_replace(' +', '\n') | trim }}\n"
        dest: "{{ deploy_dir }}/backend.env"
        owner: ubuntu
        group: ubuntu
        mode: "0600"
      no_log: true

    - name: 5. frontend.env 생성
      copy:
        content: "{{ fe_env_b64 | b64decode | regex_replace(' +', '\n') | trim }}\n"
        dest: "{{ deploy_dir }}/frontend.env"
        owner: ubuntu
        group: ubuntu
        mode: "0600"
      no_log: true

    - name: 6. kafka.env 생성
      copy:
        content: "{{ kafka_env_b64 | b64decode | regex_replace(' +', '\n') | trim }}\n"
        dest: "{{ deploy_dir }}/kafka.env"
        owner: ubuntu
        group: ubuntu
        mode: "0600"
      no_log: true

    - name: 7. docker-compose.yml 복사
      copy:
        src: ./docker-compose.yml
        dest: "{{ deploy_dir }}/docker-compose.yml"
        owner: ubuntu
        group: ubuntu
        mode: "0644"

    - name: 8. 기존 컨테이너 중지 및 제거
      community.docker.docker_compose:
        project_src: "{{ deploy_dir }}"
        state: absent
        remove_orphans: yes

    # ⬇️⬇️ (필수!) 8. DB 데이터 볼륨 완전 삭제 (초기화) ⬇️⬇️
    - name: 9. (초기화) DB 데이터 볼륨(db-data) 완전 삭제
      community.docker.docker_volume:
        name: cj-project_db-data # ◀ docker-compose가 생성한 볼륨 이름
        state: absent
        force: yes
      no_log: true # ◀ 에러 시에도 무시하고 진행 (볼륨이 원래 없었을 수 있으므로)
      failed_when: false

    # - name: 8. (강력 초기화) DB 볼륨 포함 모든 데이터 삭제
    #   ansible.builtin.shell: |
    #     docker-compose down -v --remove-orphans
    #   args:
    #     chdir: "{{ deploy_dir }}"
    #   # 처음 배포라 컨테이너가 없거나 에러가 나도 무시하고 진행
    #   ignore_errors: yes


    - name: 10. DB만 먼저 올리기
      community.docker.docker_compose:
        project_src: "{{ deploy_dir }}"
        services:
          - db
        state: present
        pull: yes
      environment:
        FRONTEND_IMAGE_TAG: "{{ fe_image_tag }}"
        BACKEND_IMAGE_TAG: "{{ be_image_tag }}"

    - name: 11. Postgres 준비 완료 대기(pg_isready)
      shell: |
        set -e
        for i in $(seq 1 60); do
          docker-compose -f "{{ deploy_dir }}/docker-compose.yml" exec -T db \
            sh -lc 'pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"' && exit 0
          sleep 2
        done
        echo "Postgres not ready in time" >&2
        exit 1
      args:
        chdir: "{{ deploy_dir }}"

    - name: 12. Run Database Migrations (Alembic)
      ansible.builtin.shell:
        cmd: |
          docker-compose -f docker-compose.yml pull backend
          
          docker-compose -f docker-compose.yml run --rm backend alembic upgrade head
      args:
        chdir: "{{ deploy_dir }}" # ◀ /home/ubuntu/cj-project 에서 실행
      environment: # ◀ docker-compose run도 이미지 태그 변수가 필요함
        FRONTEND_IMAGE_TAG: "{{ fe_image_tag }}"
        BACKEND_IMAGE_TAG: "{{ be_image_tag }}"

    - name: 13. 전체 서비스 기동(backend, frontend 포함)
      community.docker.docker_compose:
        project_src: "{{ deploy_dir }}"
        state: present
        pull: yes
      environment:
        FRONTEND_IMAGE_TAG: "{{ fe_image_tag }}"
        BACKEND_IMAGE_TAG: "{{ be_image_tag }}"