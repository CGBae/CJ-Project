# ansible/deploy.yml
# ì´ê²ƒì´ Ansibleì˜ 'ì‘ì—… ëª©ë¡(Playbook)'ì…ë‹ˆë‹¤.
# GitLab CI/CDê°€ ì´ íŒŒì¼ì„ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.

- hosts: all  # 'hosts.ini'ì— ìˆëŠ” ëª¨ë“  ì„œë²„ì— ëŒ€í•´ ì‹¤í–‰
  become: true # ğŸ’¡ [ì¤‘ìš”] ëª¨ë“  ëª…ë ¹ì„ 'sudo' (ê´€ë¦¬ì ê¶Œí•œ)ë¡œ ì‹¤í–‰
  
  vars:
    # ğŸ’¡ ë³€ìˆ˜: í”„ë¡œì íŠ¸ ê²½ë¡œë¥¼ ë¯¸ë¦¬ ì§€ì • (ë‚˜ì¤‘ì— ì„œë²„ì— ë§ê²Œ ìˆ˜ì •)
    project_path: /home/ubuntu/cjproject 
    
  tasks:
    # --- 1. ê³µí†µ ì‘ì—… (Git) ---
    - name: 1. Update source code from Git
      git:
        repo: https://github.com/CGBae/CJ-Project.git # ğŸ‘ˆ ê¹ƒë© ì£¼ì†Œë¡œ ë³€ê²½ í•„ìš”
        dest: "{{ project_path }}"
        version: Git_CICD # ğŸ‘ˆ ë°°í¬í•  ë¸Œëœì¹˜
        force: yes # ë®ì–´ì“°ê¸°
      become_user: ubuntu # ğŸ’¡ 'sudo'ê°€ ì•„ë‹Œ 'ubuntu' ì‚¬ìš©ìë¡œ git pull ì‹¤í–‰
      
    # --- 2. ë°±ì—”ë“œ ë°°í¬ ---
    - name: 2. Install Backend Python dependencies
      pip:
        requirements: "{{ project_path }}/backend/requirements.txt"
        virtualenv: "{{ project_path }}/backend/venv" # ğŸ‘ˆ ì„œë²„ì˜ venv ê²½ë¡œ
        
    - name: 3. Run Backend DB Migrations
      command:
        cmd: "alembic upgrade head"
        chdir: "{{ project_path }}/backend" # ğŸ‘ˆ alembic.iniê°€ ìˆëŠ” í´ë”
      environment:
        # ğŸ’¡ GitLab CI/CD ë³€ìˆ˜ì—ì„œ DB URLì„ ê°€ì ¸ì™€ ì£¼ì…
        DATABASE_URL: "{{ lookup('env', 'DATABASE_URL') }}" 
      become_user: ubuntu

    - name: 4. Restart Backend Server (Gunicorn/FastAPI)
      # ğŸ’¡ 'my-fastapi-app'ì€ ì„œë²„ì— ë“±ë¡ëœ systemd ì„œë¹„ìŠ¤ ì´ë¦„ (VM ì¤€ë¹„ ì‹œ ì„¤ì • í•„ìš”)
      systemd:
        name: my-fastapi-app
        state: restarted
        daemon_reload: yes

    # --- 3. í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ---
    - name: 5. Install Frontend dependencies
      command:
        cmd: "npm install --production"
        chdir: "{{ project_path }}/frontend"
      become_user: ubuntu

    - name: 6. Build Frontend (Next.js)
      command:
        cmd: "npm run build"
        chdir: "{{ project_path }}/frontend"
      environment:
        # ğŸ’¡ GitLab CI/CD ë³€ìˆ˜ì—ì„œ API ì£¼ì†Œ ë“±ì„ ê°€ì ¸ì™€ ì£¼ì…
        NEXT_PUBLIC_API_BASE_URL: "{{ lookup('env', 'NEXT_PUBLIC_API_BASE_URL') }}"
        NEXT_PUBLIC_KAKAO_REST_KEY: "{{ lookup('env', 'NEXT_PUBLIC_KAKAO_REST_KEY') }}"
        NEXT_PUBLIC_KAKAO_REDIRECT_URI: "{{ lookup('env', 'NEXT_PUBLIC_KAKAO_REDIRECT_URI') }}"
      become_user: ubuntu

    - name: 7. Restart Frontend Server (PM2)
      # ğŸ’¡ 'frontend-app'ì€ PM2ì— ë“±ë¡ëœ ì•± ì´ë¦„ (VM ì¤€ë¹„ ì‹œ ì„¤ì • í•„ìš”)
      command:
        cmd: "pm2 restart frontend-app"
      become_user: ubuntu