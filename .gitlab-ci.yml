# .gitlab-ci.yml
# GitLab CI/CDì˜ ë©”ì¸ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤.

# 1. íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
stages:
  - build   # ë¹Œë“œ (Next.js)
  - deploy  # ë°°í¬ (Ansible)

# 2. CI (ë¹Œë“œ) ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œê°€ ìœ íš¨í•œì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
# (Vercelì´ í•´ì£¼ë˜ 'npm run build'ë¥¼ GitLab Runnerê°€ ëŒ€ì‹ í•©ë‹ˆë‹¤.)
build_frontend:
  stage: build
  image: node:18-alpine # ğŸ’¡ Node.js 18 ë²„ì „ í™˜ê²½ ì‚¬ìš©
  cache:
    key:
      files:
        - frontend/package-lock.json
    paths:
      - frontend/node_modules/
  script:
    - echo "Starting Frontend Build..."
    - cd frontend
    - npm install
    # ğŸ’¡ [ì¤‘ìš”] ë¹Œë“œ ì‹œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ë¥¼ GitLab ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    #    (ì´ ë³€ìˆ˜ë“¤ì€ 4ë‹¨ê³„ì—ì„œ GitLabì— ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.)
    - npm run build
  artifacts:
    # ë¹Œë“œ ê²°ê³¼ë¬¼(.next)ì„ ë‹¤ìŒ ë‹¨ê³„(ë°°í¬)ë¡œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì„ íƒì )
    paths:
      - frontend/.next/
  only:
    refs:
      - Git_CICD # ğŸ‘ˆ Git_CICD ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰
    changes:
      - frontend/**/* # ğŸ‘ˆ frontend í´ë”ê°€ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰

# 3. CD (ë°°í¬) ë‹¨ê³„: Ansibleì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
deploy_to_server:
  stage: deploy
  image: alpine:latest # ğŸ’¡ ê°€ë²¼ìš´ ë¦¬ëˆ…ìŠ¤ ì´ë¯¸ì§€
  
  before_script:
    # 1. Ansibleê³¼ SSH í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜
    - apk add --no-cache ansible openssh-client
    # 2. GitLab ë³€ìˆ˜ì— ì €ì¥ëœ SSH í‚¤ë¥¼ Runnerì— ë“±ë¡
    - eval $(ssh-agent -s)
    - echo "$SERVER_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config

  script:
    - echo "Deploying to KT Cloud VM..."
    # 3. ğŸ’¡ [í•µì‹¬] Ansible Playbook ì‹¤í–‰
    #    $SERVER_HOST, $SERVER_USERëŠ” 4ë‹¨ê³„ì—ì„œ ë“±ë¡í•  GitLab ë³€ìˆ˜ì…ë‹ˆë‹¤.
    - ansible-playbook -i "$SERVER_USER@$SERVER_HOST," ansible/deploy.yml
  
  when: on_success # ğŸ’¡ 'build' ë‹¨ê³„ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
  
  only:
    refs:
      - Git_CICD
    changes:
      # ğŸ’¡ ë°±ì—”ë“œ, í”„ë¡ íŠ¸ì—”ë“œ, ì•¤ì„œë¸” ì½”ë“œê°€ ë³€ê²½ë˜ë©´ ë°°í¬ ì‹¤í–‰
      - backend/**/*
      - frontend/**/*
      - ansible/deploy.yml