# .gitlab-ci.yml

# ğŸ’¡ 1. [ìˆ˜ì •] ë‹¨ê³„ë¥¼ 3ê°œë¡œ ë¶„ë¦¬: build -> test -> deploy
stages:
  - build
  - test
  - deploy

# 2. CI (ë¹Œë“œ) ë‹¨ê³„ (ë³€ê²½ ì—†ìŒ)
build_frontend:
  stage: build
  image: node:18-alpine
  cache:
    key:
      files:
        - frontend/package-lock.json
    paths:
      - frontend/node_modules/
  script:
    - echo "Starting Frontend Build..."
    - cd frontend
    - npm install
    - npm run build
  artifacts:
    paths:
      - frontend/.next/
  only:
    refs:
      - Git_CICD
    changes:
      - frontend/**/*

# 3. ğŸ’¡ [í•µì‹¬ ì¶”ê°€] Ansible ë¬¸ë²• ê²€ì‚¬ ë‹¨ê³„
test_ansible_syntax:
  stage: test
  image: alpine:latest # ğŸ‘ˆ ê°€ë²¼ìš´ ì´ë¯¸ì§€ ì‚¬ìš©
  
  before_script:
    # 1. Ansible ì„¤ì¹˜ (SSH í´ë¼ì´ì–¸íŠ¸ëŠ” í•„ìš” ì—†ìŒ)
    - apk add --no-cache ansible
    
  script:
    - echo "Checking Ansible playbook syntax..."
    # 2. ğŸ’¡ ansible/deploy.yml íŒŒì¼ì˜ ë¬¸ë²•ë§Œ ê²€ì‚¬ (SSH ì ‘ì† ì•ˆ í•¨)
    #    'localhost,'ëŠ” ì„ì‹œ ì¸ë²¤í† ë¦¬(ì£¼ì†Œë¡)ë¥¼ ì œê³µí•˜ëŠ” êµ¬ë¬¸ì…ë‹ˆë‹¤.
    - ansible-playbook -i "localhost," --syntax-check ansible/deploy.yml
    
  when: on_success # ğŸ‘ˆ 'build' ë‹¨ê³„ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
  
  only:
    refs:
      - Git_CICD
    changes:
      # ğŸ’¡ Ansible íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - ansible/deploy.yml
      - .gitlab-ci.yml

# 4. CD (ë°°í¬) ë‹¨ê³„ (ë³€ê²½ ì—†ìŒ)
deploy_to_server:
  stage: deploy
  image: alpine:latest 
  
  before_script:
    # (ê¸°ì¡´ê³¼ ë™ì¼) Ansibleê³¼ SSH í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜
    - apk add --no-cache ansible openssh-client
    # (ê¸°ì¡´ê³¼ ë™ì¼) SSH í‚¤ ë“±ë¡ (VM ì¤€ë¹„ ì „ê¹Œì§€ ì—¬ê¸°ì„œ ì‹¤íŒ¨í•˜ëŠ” ê²ƒì´ ì •ìƒ)
    - eval $(ssh-agent -s)
    - echo "$SERVER_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config

  script:
    - echo "Deploying to KT Cloud VM..."
    # (ê¸°ì¡´ê³¼ ë™ì¼) Ansible Playbook ì‹¤í–‰
    - ansible-playbook -i "$SERVER_USER@$SERVER_HOST," ansible/deploy.yml
  
  when: on_success # ğŸ‘ˆ 'test' ë‹¨ê³„ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
  
  only:
    refs:
      - Git_CICD
    changes:
      - backend/**/*
      - frontend/**/*
      - ansible/deploy.yml